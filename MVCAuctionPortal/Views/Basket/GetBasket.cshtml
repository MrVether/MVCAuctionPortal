@model MVCAuctionPortal.Models.BasketViewModel
@{
    ViewBag.Title = "Koszyk";
}

<h2>Koszyk</h2>
<form id="basket-form" method="post" asp-action="UpdateBasket" asp-controller="Basket">
    <table class="table">
        <thead>
            <tr>
                <th>Nazwa</th>
                <th>Cena</th>
                <th>Ilość</th>
                <th>Usuń</th>
                <th>Wybrane</th>
            </tr>
        </thead>
        <tbody>
            @for (var i = 0; i < Model.BasketAuctions.Count; i++)
            {
                <tr>
                    <td>@Model.BasketAuctions[i].Title</td>
                    <td>@Model.BasketAuctions[i].Price</td>

                    <td>
                        <input type="number" min="0" value="@Model.BasketAuctions[i].Quantity" data-auction-id="@Model.BasketAuctions[i].AuctionId" data-price="@Model.BasketAuctions[i].Price" class="quantity-input" name="Quantity[@i]" />
                        <input type="hidden" name="AuctionId[@i]" value="@Model.BasketAuctions[i].AuctionId" />
                    </td>
                    <td>
                        <form method="post" action="@Url.Action("DeleteFromBasket", "Basket")">
                            <input type="hidden" name="auctionId" value="@Model.BasketAuctions[i].AuctionId" />
                            <button class="btn btn-danger remove-button">Usuń</button>
                        </form>
                    </td>
                    <td>
                        <input type="checkbox" @(Model.BasketAuctions[i].Selected ? "checked" : "") data-auction-id="@Model.BasketAuctions[i].AuctionId" class="selected-checkbox" name="Selected[@i]" />
                    </td>
                </tr>
            }
        </tbody>
    </table>
    <input type="submit" value="Zapisz" class="btn btn-primary" />
</form>

<p>
    <strong>Suma wybranych:</strong> <span id="summary-price">@Model.SummaryPrice</span>
</p>

@section Scripts {
    <script>
        $(function () {
            function updateSummaryPrice() {
                var summaryPrice = 0;
                $(".selected-checkbox:checked").each(function () {
                    var auctionId = $(this).data("auction-id");
                    var quantityInput = $(".quantity-input[data-auction-id='" + auctionId + "']");
                    var price = parseFloat(quantityInput.data("price"));
                    var quantity = parseInt(quantityInput.val());

                    summaryPrice += price * quantity;
                });

                $("#summary-price").text(summaryPrice.toFixed(2));
            }

            $(".quantity-input").on("change", updateSummaryPrice);
            $(".selected-checkbox").on("change", updateSummaryPrice);

            $(".remove-button").on("click", function (event) {
                event.preventDefault();

                var form = $(this).closest("form");
                var auctionId = form.find("input[name='auctionId']").val();

                $.post("/Basket/DeleteFromBasket", { auctionId: auctionId }, function () {
                    form.closest("tr").remove();
                    updateSummaryPrice();
                });
            });

            updateSummaryPrice();
        });
    </script>
}
