@model AuctionPortal.Models.Order
@{
    ViewBag.Title = "Płatność";
}

<h2>Wybierz opcję płatności</h2>

<form id="payment-form">
    <input type="hidden" id="payment-method" name="payment-method" value="" />
    <div id="paypal-button-container"></div>
</form>

@section Scripts {
    <script src="https://www.paypal.com/sdk/js?client-id=AVeV6n5vx3KnFjNQGvrX7Xlt57gZ21IErJSYLCR5MolZw7W223vV0pIXz9fDGS8nvRRlLvoqqYzMMYnl"></script>
    <script>
        var orderId = @Model.OrderID;
        var items = @Html.Raw(Json.Serialize(Model.OrderItems.Select(oi => new { title = oi.Auction.Title, price = oi.Auction.Price, quantity = oi.Quantity })));

        paypal.Buttons({
            createOrder: function (data, actions) {
                // This function sets up the details of the transaction, including the amount and line item details.

                // Calculate the total price
                var totalPrice = 0;
                for (var i = 0; i < items.length; i++) {
                    totalPrice += items[i].price * items[i].quantity;
                }

                return actions.order.create({
                    purchase_units: [{
                        amount: {
                            currency_code: "USD",
                            value: totalPrice.toFixed(2),
                            breakdown: {
                                item_total: {
                                    currency_code: "USD",
                                    value: totalPrice.toFixed(2)
                                }
                            }
                        },
                        items: items.map(function (item) {
                            return {
                                name: item.title,
                                unit_amount: {
                                    currency_code: "USD",
                                    value: item.price.toFixed(2)
                                },
                                quantity: item.quantity
                            };
                        })
                    }]
                });
            },
            onApprove: function (data, actions) {
                return actions.order.capture().then(function (details) {
                    document.getElementById('payment-method').value = 'paypal';

                    var paymentMethod = document.getElementById('payment-method').value;

                    // Redirect to the PaymentSuccess action
                    window.location.href = '/Order/PaymentSuccess?id=' + orderId + '&paymentMethod=' + paymentMethod;
                }).catch(function (error) {
                    // Handle any errors that occurred during capture
                    console.error('Capture error:', error);

                    // Redirect to the PaymentFailed action
                    window.location.href = '/Order/PaymentFailed?id=' + orderId;
                });
            },
            onError: function (err) {
                // Handle any errors that occurred during the payment process
                console.error('Payment error:', err);

                // Redirect to the PaymentFailed action
                window.location.href = '/Order/PaymentFailed?id=' + orderId;
            },
            onCancel: function (data) {
                // This function is called when the user cancels the payment
                console.log('Payment cancelled.');

                // Redirect to the PaymentFailed action
                window.location.href = '/Order/PaymentFailed?id=' + orderId;
            }
        }).render('#paypal-button-container');
    </script>
}
